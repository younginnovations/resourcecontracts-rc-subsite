!function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone","../../../../public/js/lib/jquery"],function(c,r,i){return e.Backbone=t(c,r,i)}):"undefined"!=typeof exports&&"undefined"!=typeof require?module.exports=t(require("underscore"),require("backbone"),require("jquery")):e.Backbone=t(e._,e.Backbone,e.jQuery)}(this,function(e,t,c){function r(t,r){if(t&&e.isObject(t)){if(e.isFunction(t.getCacheKey))return t.getCacheKey(r);t=r&&r.url?r.url:e.isFunction(t.url)?t.url():t.url}else if(e.isFunction(t))return t(r);return r&&r.data?"string"==typeof r.data?t+"?"+r.data:t+"?"+c.param(r.data):t}function i(e,c,r){c=c||{};var i=t.fetchCache.getCacheKey(e,c),n=!1,o=c.lastSync||(new Date).getTime(),s=!1;i&&c.cache!==!1&&(c.cache||c.prefill)&&(c.expires!==!1&&(n=(new Date).getTime()+1e3*(c.expires||300)),c.prefillExpires!==!1&&(s=(new Date).getTime()+1e3*(c.prefillExpires||300)),t.fetchCache._cache[i]={expires:n,lastSync:o,prefillExpires:s,value:r},t.fetchCache.setLocalStorage())}function n(c,i){return e.isFunction(c)?c=c():c&&e.isObject(c)&&(c=r(c,i)),t.fetchCache._cache[c]}function o(e){return n(e).lastSync}function s(c,i){e.isFunction(c)?c=c():c&&e.isObject(c)&&(c=r(c,i)),delete t.fetchCache._cache[c],t.fetchCache.setLocalStorage()}function a(){if(f&&t.fetchCache.localStorage)try{localStorage.setItem(t.fetchCache.getLocalStorageKey(),JSON.stringify(t.fetchCache._cache))}catch(e){var c=e.code||e.number||e.message;if(22!==c&&1014!==c)throw e;this._deleteCacheWithPriority()}}function l(){if(f&&t.fetchCache.localStorage){var e=localStorage.getItem(t.fetchCache.getLocalStorageKey())||"{}";t.fetchCache._cache=JSON.parse(e)}}function h(e){return window.setTimeout(e,0)}var u={modelFetch:t.Model.prototype.fetch,modelSync:t.Model.prototype.sync,collectionFetch:t.Collection.prototype.fetch},f=function(){var e="undefined"!=typeof window.localStorage;if(e)try{localStorage.setItem("test_support","test_support"),localStorage.removeItem("test_support")}catch(t){e=!1}return e}();return t.fetchCache=t.fetchCache||{},t.fetchCache._cache=t.fetchCache._cache||{},t.fetchCache.enabled=!0,t.fetchCache.priorityFn=function(e,t){return e&&e.expires&&t&&t.expires?e.expires-t.expires:e},t.fetchCache._prioritize=function(){var t=e.values(this._cache).sort(this.priorityFn),c=e.indexOf(e.values(this._cache),t[0]);return e.keys(this._cache)[c]},t.fetchCache._deleteCacheWithPriority=function(){t.fetchCache._cache[this._prioritize()]=null,delete t.fetchCache._cache[this._prioritize()],t.fetchCache.setLocalStorage()},t.fetchCache.getLocalStorageKey=function(){return"backboneCache"},"undefined"==typeof t.fetchCache.localStorage&&(t.fetchCache.localStorage=!0),t.Model.prototype.fetch=function(r){function i(){return r.prefill&&(!r.prefillExpires||f)}function o(){r.parse&&(p=C.parse(p,r)),C.set(p,r),e.isFunction(r.prefillSuccess)&&r.prefillSuccess(C,p,r),C.trigger("cachesync",C,p,r),C.trigger("sync",C,p,r),i()?d.notify(C):(e.isFunction(r.success)&&r.success(C,p,r),d.resolve(C))}if(!t.fetchCache.enabled)return u.modelFetch.apply(this,arguments);r=e.defaults(r||{},{parse:!0});var s=t.fetchCache.getCacheKey(this,r),a=n(s),l=!1,f=!1,p=!1,d=new c.Deferred,C=this;if(a&&(l=a.expires,l=l&&a.expires<(new Date).getTime(),f=a.prefillExpires,f=f&&a.prefillExpires<(new Date).getTime(),p=a.value),!l&&(r.cache||r.prefill)&&p&&(null==r.async&&(r.async=!0),r.async?h(o):o(),!i()))return d;var y=u.modelFetch.apply(this,arguments);return y.done(e.bind(d.resolve,this,this)).done(e.bind(t.fetchCache.setCache,null,this,r)).fail(e.bind(d.reject,this,this)),d.abort=y.abort,d},t.Model.prototype.sync=function(e,c,r){if("read"===e||!t.fetchCache.enabled)return u.modelSync.apply(this,arguments);var i,n,o=c.collection,a=[];for(a.push(t.fetchCache.getCacheKey(c,r)),o&&a.push(t.fetchCache.getCacheKey(o)),i=0,n=a.length;n>i;i++)s(a[i]);return u.modelSync.apply(this,arguments)},t.Collection.prototype.fetch=function(r){function i(){return r.prefill&&(!r.prefillExpires||f)}function o(){C[r.reset?"reset":"set"](p,r),e.isFunction(r.prefillSuccess)&&r.prefillSuccess(C),C.trigger("cachesync",C,p,r),C.trigger("sync",C,p,r),i()?d.notify(C):(e.isFunction(r.success)&&r.success(C,p,r),d.resolve(C))}if(!t.fetchCache.enabled)return u.collectionFetch.apply(this,arguments);r=e.defaults(r||{},{parse:!0});var s=t.fetchCache.getCacheKey(this,r),a=n(s),l=!1,f=!1,p=!1,d=new c.Deferred,C=this;if(a&&(l=a.expires,l=l&&a.expires<(new Date).getTime(),f=a.prefillExpires,f=f&&a.prefillExpires<(new Date).getTime(),p=a.value),!l&&(r.cache||r.prefill)&&p&&(null==r.async&&(r.async=!0),r.async?h(o):o(),!i()))return d;var y=u.collectionFetch.apply(this,arguments);return y.done(e.bind(d.resolve,this,this)).done(e.bind(t.fetchCache.setCache,null,this,r)).fail(e.bind(d.reject,this,this)),d.abort=y.abort,d},l(),t.fetchCache._superMethods=u,t.fetchCache.setCache=i,t.fetchCache.getCache=n,t.fetchCache.getCacheKey=r,t.fetchCache.getLastSync=o,t.fetchCache.clearItem=s,t.fetchCache.setLocalStorage=a,t.fetchCache.getLocalStorage=l,t}),$.ajaxSetup({cache:!0});var ResourceModel=Backbone.Model.extend(),FilterCollection=Backbone.Collection.extend({model:ResourceModel,initialize:function(){this.sortField="name",this.sortDirection="ASC"},setSortField:function(e,t){this.sortField=e,this.sortDirection=t},comparator:function(e){return e.get(this.sortField)},sortBy:function(e,t){var c=this.models,r=this.sortDirection;return _.pluck(_.map(c,function(c,r,i){return{value:c,index:r,criteria:e.call(t,c,r,i)}}).sort(function(e,t){var c="ASC"===r?e.criteria:t.criteria,i="ASC"===r?t.criteria:e.criteria;if(c!==i){if(c>i||void 0===c)return 1;if(c<i||void 0===i)return-1}return e.index<t.index?-1:1}),"value")}}),ResourceCollection=Backbone.Collection.extend({initialize:function(e){this.url=e},model:ResourceModel,url:this.url,search:function(e){var t="resource";if("undefined"==typeof e||""==e)return this;var c=new RegExp(e,"gi");return _(this.filter(function(e){return c.test(e.get(t))}))},resources:function(e,t){var c;c=this.search(e),c=new FilterCollection(c.toArray()),"undefined"!=typeof t&&(c.setSortField("resource",t.toUpperCase()),c.sort());var r=[];return _.each(c.models,function(e){r.push({value:encodeURIComponent(e.get("resource")),name:e.get("resource"),contract:e.get("contract")})}),r}}),ResourceView=Backbone.View.extend({initialize:function(){this.template=_.template($("#resource-template").html())},render:function(){return this.el=this.template(this.model),this}}),ResourceList=Backbone.View.extend({initialize:function(e){this.query=e.query,this.sort_type=e.sort_type,this.collection.on("sort",this.sort,this),this.collection.on("search",this.search,this),this.collection.on("reset",this.render,this)},search:function(e){this.query=e,this.render()},sort:function(e){this.sort_type=e,this.render()},render:function(){var e=this,t=this.collection.resources(this.query,this.sort_type,this.resources);return $(e.el).html(""),_.each(t,function(t){$(e.el).append(new ResourceView({model:t}).render().el)}),this}}),CountryModel=Backbone.Model.extend(),CountryController=Backbone.Collection.extend({initialize:function(e){this.url=e},model:CountryModel,url:this.url,resources:function(){var e=this;e=new FilterCollection(e.toArray()),e.setSortField("name","ASC"),e.sort();var t=[];return e.each(function(e){t.push({code:e.get("code"),name:e.get("name"),contract:e.get("contract")})}),t}}),CountryView=Backbone.View.extend({initialize:function(){this.template=_.template($("#country-template").html())},render:function(){return this.el=this.template(this.model),this}}),CountryList=Backbone.View.extend({initialize:function(){this.collection.on("reset",this.render,this)},render:function(){var e=this,t=this.collection.resources();return $(e.el).html(""),_.each(t,function(t){$(e.el).append(new CountryView({model:t}).render().el)}),this}}),collection=new ResourceCollection(APP_URL+"/contract/resources");collection.fetch({reset:!0,cache:!0,expires:6e4});var resourceList=new ResourceList({el:"#resources",sort_type:"asc",collection:collection}).el,rCollection=new CountryController(APP_URL+"/contract/countries");rCollection.fetch({reset:!0,cache:!0,expires:6e4});var countryList=new CountryList({el:"#countries",collection:rCollection});$(function(){$(document).on("click",".country",function(){var e=[];$(".country:checked").each(function(){e.push($(this).val())}),collection.url=APP_URL+"/contract/resources?country="+e.join(),collection.fetch({reset:!0,cache:!0,expires:6e4,success:function(){$("#resources").find(".col-lg-4").removeClass("col-lg-4").addClass("col-lg-6"),$(".side-collapse").css("height",$("#resources").height()+150+"px")}})}),$(document).on("change",".sort",function(e){e.preventDefault(),collection.trigger("sort",$(this).val())}),$(document).on("input",".search",function(e){e.preventDefault(),collection.trigger("search",$(this).val())})});