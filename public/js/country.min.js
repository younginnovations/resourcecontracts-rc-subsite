!function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone","../../../../public/js/lib/jquery"],function(c,i,r){return e.Backbone=t(c,i,r)}):"undefined"!=typeof exports&&"undefined"!=typeof require?module.exports=t(require("underscore"),require("backbone"),require("jquery")):e.Backbone=t(e._,e.Backbone,e.jQuery)}(this,function(e,t,c){function i(t,i){if(t&&e.isObject(t)){if(e.isFunction(t.getCacheKey))return t.getCacheKey(i);t=i&&i.url?i.url:e.isFunction(t.url)?t.url():t.url}else if(e.isFunction(t))return t(i);return i&&i.data?"string"==typeof i.data?t+"?"+i.data:t+"?"+c.param(i.data):t}function r(e,c,i){c=c||{};var r=t.fetchCache.getCacheKey(e,c),n=!1,o=c.lastSync||(new Date).getTime(),s=!1;r&&c.cache!==!1&&(c.cache||c.prefill)&&(c.expires!==!1&&(n=(new Date).getTime()+1e3*(c.expires||300)),c.prefillExpires!==!1&&(s=(new Date).getTime()+1e3*(c.prefillExpires||300)),t.fetchCache._cache[r]={expires:n,lastSync:o,prefillExpires:s,value:i},t.fetchCache.setLocalStorage())}function n(c,r){return e.isFunction(c)?c=c():c&&e.isObject(c)&&(c=i(c,r)),t.fetchCache._cache[c]}function o(e){return n(e).lastSync}function s(c,r){e.isFunction(c)?c=c():c&&e.isObject(c)&&(c=i(c,r)),delete t.fetchCache._cache[c],t.fetchCache.setLocalStorage()}function l(){if(f&&t.fetchCache.localStorage)try{localStorage.setItem(t.fetchCache.getLocalStorageKey(),JSON.stringify(t.fetchCache._cache))}catch(e){var c=e.code||e.number||e.message;if(22!==c&&1014!==c)throw e;this._deleteCacheWithPriority()}}function a(){if(f&&t.fetchCache.localStorage){var e=localStorage.getItem(t.fetchCache.getLocalStorageKey())||"{}";t.fetchCache._cache=JSON.parse(e)}}function h(e){return window.setTimeout(e,0)}var u={modelFetch:t.Model.prototype.fetch,modelSync:t.Model.prototype.sync,collectionFetch:t.Collection.prototype.fetch},f=function(){var e="undefined"!=typeof window.localStorage;if(e)try{localStorage.setItem("test_support","test_support"),localStorage.removeItem("test_support")}catch(t){e=!1}return e}();return t.fetchCache=t.fetchCache||{},t.fetchCache._cache=t.fetchCache._cache||{},t.fetchCache.enabled=!0,t.fetchCache.priorityFn=function(e,t){return e&&e.expires&&t&&t.expires?e.expires-t.expires:e},t.fetchCache._prioritize=function(){var t=e.values(this._cache).sort(this.priorityFn),c=e.indexOf(e.values(this._cache),t[0]);return e.keys(this._cache)[c]},t.fetchCache._deleteCacheWithPriority=function(){t.fetchCache._cache[this._prioritize()]=null,delete t.fetchCache._cache[this._prioritize()],t.fetchCache.setLocalStorage()},t.fetchCache.getLocalStorageKey=function(){return"backboneCache"},"undefined"==typeof t.fetchCache.localStorage&&(t.fetchCache.localStorage=!0),t.Model.prototype.fetch=function(i){function r(){return i.prefill&&(!i.prefillExpires||f)}function o(){i.parse&&(d=C.parse(d,i)),C.set(d,i),e.isFunction(i.prefillSuccess)&&i.prefillSuccess(C,d,i),C.trigger("cachesync",C,d,i),C.trigger("sync",C,d,i),r()?p.notify(C):(e.isFunction(i.success)&&i.success(C,d,i),p.resolve(C))}if(!t.fetchCache.enabled)return u.modelFetch.apply(this,arguments);i=e.defaults(i||{},{parse:!0});var s=t.fetchCache.getCacheKey(this,i),l=n(s),a=!1,f=!1,d=!1,p=new c.Deferred,C=this;if(l&&(a=l.expires,a=a&&l.expires<(new Date).getTime(),f=l.prefillExpires,f=f&&l.prefillExpires<(new Date).getTime(),d=l.value),!a&&(i.cache||i.prefill)&&d&&(null==i.async&&(i.async=!0),i.async?h(o):o(),!r()))return p;var y=u.modelFetch.apply(this,arguments);return y.done(e.bind(p.resolve,this,this)).done(e.bind(t.fetchCache.setCache,null,this,i)).fail(e.bind(p.reject,this,this)),p.abort=y.abort,p},t.Model.prototype.sync=function(e,c,i){if("read"===e||!t.fetchCache.enabled)return u.modelSync.apply(this,arguments);var r,n,o=c.collection,l=[];for(l.push(t.fetchCache.getCacheKey(c,i)),o&&l.push(t.fetchCache.getCacheKey(o)),r=0,n=l.length;n>r;r++)s(l[r]);return u.modelSync.apply(this,arguments)},t.Collection.prototype.fetch=function(i){function r(){return i.prefill&&(!i.prefillExpires||f)}function o(){C[i.reset?"reset":"set"](d,i),e.isFunction(i.prefillSuccess)&&i.prefillSuccess(C),C.trigger("cachesync",C,d,i),C.trigger("sync",C,d,i),r()?p.notify(C):(e.isFunction(i.success)&&i.success(C,d,i),p.resolve(C))}if(!t.fetchCache.enabled)return u.collectionFetch.apply(this,arguments);i=e.defaults(i||{},{parse:!0});var s=t.fetchCache.getCacheKey(this,i),l=n(s),a=!1,f=!1,d=!1,p=new c.Deferred,C=this;if(l&&(a=l.expires,a=a&&l.expires<(new Date).getTime(),f=l.prefillExpires,f=f&&l.prefillExpires<(new Date).getTime(),d=l.value),!a&&(i.cache||i.prefill)&&d&&(null==i.async&&(i.async=!0),i.async?h(o):o(),!r()))return p;var y=u.collectionFetch.apply(this,arguments);return y.done(e.bind(p.resolve,this,this)).done(e.bind(t.fetchCache.setCache,null,this,i)).fail(e.bind(p.reject,this,this)),p.abort=y.abort,p},a(),t.fetchCache._superMethods=u,t.fetchCache.setCache=r,t.fetchCache.getCache=n,t.fetchCache.getCacheKey=i,t.fetchCache.getLastSync=o,t.fetchCache.clearItem=s,t.fetchCache.setLocalStorage=l,t.fetchCache.getLocalStorage=a,t}),$.ajaxSetup({cache:!0});var CountryModel=Backbone.Model.extend(),FilterCountryCollection=Backbone.Collection.extend({model:CountryModel,initialize:function(){this.sortField="name",this.sortDirection="ASC"},setSortField:function(e,t){this.sortField=e,this.sortDirection=t},comparator:function(e){return e.get(this.sortField)},sortBy:function(e,t){var c=this.models,i=this.sortDirection;return _.pluck(_.map(c,function(c,i,r){return{value:c,index:i,criteria:e.call(t,c,i,r)}}).sort(function(e,t){var c="ASC"===i?e.criteria:t.criteria,r="ASC"===i?t.criteria:e.criteria;if(c!==r){if(c>r||void 0===c)return 1;if(c<r||void 0===r)return-1}return e.index<t.index?-1:1}),"value")}}),CountryCollection=Backbone.Collection.extend({initialize:function(e){this.url=e},model:CountryModel,url:this.url,search:function(e){var t="name",c="code";if("undefined"==typeof e||""==e)return this;var i=new RegExp(e,"gi");return _(this.filter(function(e){return i.test(e.get(t))||i.test(e.get(c))}))},countries:function(e,t){var c;c=this.search(e),c=new FilterCountryCollection(c.toArray()),"undefined"!=typeof t&&(c.setSortField("name",t.toUpperCase()),c.sort());var i=[];return _.each(c.models,function(e){i.push({code:e.get("code"),name:e.get("name"),contract:e.get("contract")})}),i}}),CountryView=Backbone.View.extend({initialize:function(){this.template=_.template($("#country-template").html())},render:function(){return this.el=this.template(this.model),this}}),CountryList=Backbone.View.extend({initialize:function(e){this.query=e.query,this.sort_type=e.sort_type,this.collection.on("sort",this.sort,this),this.collection.on("search",this.search,this),this.collection.on("reset",this.render,this)},search:function(e){this.query=e,this.render()},sort:function(e){this.sort_type=e,this.render()},render:function(){var e=this,t=this.collection.countries(this.query,this.sort_type,this.resources);return $(e.el).html(""),_.each(t,function(t){$(e.el).append(new CountryView({model:t}).render().el)}),this}}),ResourceModel=Backbone.Model.extend(),ResourceController=Backbone.Collection.extend({initialize:function(e){this.url=e},model:ResourceModel,url:this.url,resources:function(){var e=this;e=new FilterCountryCollection(e.toArray()),e.setSortField("resource","ASC"),e.sort();var t=[];return e.each(function(e){t.push({name:e.get("resource"),value:e.get("resource"),contract:e.get("contract")})}),t}}),ResourceView=Backbone.View.extend({initialize:function(){this.template=_.template($("#resource-template").html())},render:function(){return this.el=this.template(this.model),this}}),ResourceList=Backbone.View.extend({initialize:function(){this.collection.on("reset",this.render,this)},render:function(){var e=this,t=this.collection.resources();return $(e.el).html(""),_.each(t,function(t){$(e.el).append(new ResourceView({model:t}).render().el)}),this}}),collection=new CountryCollection(APP_URL+"/contract/countries");collection.fetch({reset:!0,cache:!0,expires:6e4});var countryList=new CountryList({el:"#countries",sort_type:"asc",collection:collection}).el,rCollection=new ResourceController(APP_URL+"/contract/resources");rCollection.fetch({reset:!0,cache:!0,expires:6e4});var resourceList=new ResourceList({el:"#resources",collection:rCollection});$(function(){$(document).on("click",".resource",function(){var e=[];$(".resource:checked").each(function(){e.push($(this).val())}),collection.url=APP_URL+"/contract/countries?resource="+e.join(),collection.fetch({reset:!0,cache:!0,expires:6e4,success:function(){$("#countries").find(".col-lg-2").removeClass("col-lg-2").addClass("col-lg-3"),$(".side-collapse").css("height",$("#countries").height()+150+"px"),$(window).width()<1200&&$("#countries").find(".col-md-3,.col-md-6").toggleClass("col-md-3").toggleClass("col-md-6"),$(window).width()<992&&$("#countries").find(".col-sm-4,.col-sm-6").toggleClass("col-sm-4").toggleClass("col-sm-6"),$(window).width()<768&&$("#countries").find(".col-xs-6,.col-xs-12").toggleClass("col-xs-6").toggleClass("col-xs-12")}})}),$(document).on("change",".sort",function(e){e.preventDefault(),collection.trigger("sort",$(this).val())}),$(document).on("input",".search",function(e){e.preventDefault(),collection.trigger("search",$(this).val())})});